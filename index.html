<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=9c27222d6d125405f41ceb7ee06ba495&libraries=services"></script>
    <title>카카오맵 마커 프로젝트</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">
</head>
<body>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js" integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI" crossorigin="anonymous"></script>
<h1>카카오맵 마커 프로젝트</h1>
<!-- 화면 UI -->
 <div class="d-flex w-100">
    <!-- 지도 위치 -->
    <div id="map" class="w-75" style="height:60vh;"></div>
    <!-- 마커 위치 정보 및 버튼 -->
    <div class="w-25 ps-3 d-flex flex-column">
        <div id="info" class="flex-fill mb-3 p-3 border rounded bg-light">지도를 클릭해보세요</div>
        <div class="d-flex gap-2">
            <button type="button" class="btn btn-primary btn-lg flex-fill" onclick="setMarker()">즐겨찾기 등록</button>
            <button type="button" class="btn btn-secondary btn-lg flex-fill" onclick="deleteMarker()">삭제</button>
        </div>
    </div>
 </div>
<button type="button" id="btn_fav" class="btn btn-dark mt-3" onclick="getMarkers()">즐겨찾기</button>
<div class="input-group mb-3">
    <span class="input-group-text" id="inputGroup-sizing-default">장소명</span>
    <input type="text" id="txt_plc_name" class="form-control" aria-label="Sizing example input" aria-describedby="inputGroup-sizing-default">
</div>
<div class="input-group">
    <span class="input-group-text">위도/경도</span>
    <input type="text" id="txt_lat" aria-label="lat" class="form-control" disabled>
    <input type="text" id="txt_lng" aria-label="lng" class="form-control" disabled>
</div>
<!-- <button type="button" class="btn btn-primary" onclick="setMarker()">마커등록</button>
<button type="button" class="btn btn-dark" onclick="deleteMarker()">삭제</button> -->
<!-- ============================= 스크립트 ========================================== -->
<script>
//지도를 담을 영역의 DOM 레퍼런스
var container = document.getElementById('map'); //지도를 담을 영역의 DOM 레퍼런스
var options = { //지도를 생성할 때 필요한 기본 옵션
    center: new kakao.maps.LatLng(37.504502, 127.053617), //지도의 중심좌표.
    level: 3 //지도의 레벨(확대, 축소 정도)
};

var map         = new kakao.maps.Map(container, options);    //지도 생성 및 객체 리턴
var btnFav      = document.getElementById("btn_fav");        // 등록 버튼
let inpPlcName  = document.getElementById("txt_plc_name");   // 장소명
let inpLat      = document.getElementById("txt_lat");        // 위도
let inpLng      = document.getElementById("txt_lng");        // 경도
let divInfo     = document.getElementById("info");           // 주소

let savedMarkers = [];  // 즐겨찾기 전역 배열
let markersVisible = false;     // 즐겨찾기 마커 보임 여부
var infowindow;     // 인포윈도우
let curSavedMarker = null;

// 즐겨찾기 마커 이미지
var imageSrc = "https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/markerStar.png"; 
var imageSize = new kakao.maps.Size(24, 35); // 이미지 크기
var markerImage = new kakao.maps.MarkerImage(imageSrc, imageSize) // 마커 이미지 생성

// 전역 마커 생성(위치는 클릭 시 이동할 것이므로 안써줘도 됨)
var tempMarker = new kakao.maps.Marker({
                    map : map
                });

// 주소 변환 객체 + 장소 검색 객체 생성
const geocoder = new kakao.maps.services.Geocoder();
const ps = new kakao.maps.services.Places();

// 지도에 클릭 이벤트 등록
kakao.maps.event.addListener(map, 'click', (mouseEvent)=>{
    if(markersVisible){
        return;     // 즐겨찾기 모드일 땐 마커찍지 않기
    }
    // 클릭한 위도, 경도 정보 가져오기
    let latlng = mouseEvent.latLng;
    let getLat = latlng.getLat()
    let getLng = latlng.getLng()

    // 마커 위치를 클릭한 위치로 옮깁니다
    tempMarker.setPosition(latlng);

    // 만약 마커가 사라진 상태라면 다시 지도에 올림
    if (!tempMarker.getMap()) {
        tempMarker.setMap(map);
    }

    // 좌표 => 주소 변환 
    geocoder.coord2Address(getLng, getLat, (result, status) => {
        let addressName = "";
        if(status === kakao.maps.services.Status.OK){
            console.log('Geocoder result:', result);
            
            // 주소 정보가 있는 경우
            if(result && result.length > 0){
                const address = result[0].address;
                const roadAddress = result[0].road_address;
                
                // 도로명주소가 있으면 도로명주소를, 없으면 지번주소를 사용
                addressName = roadAddress ? roadAddress.address_name : address.address_name;                
                
                console.log('주소 변환 성공:', addressName);
            } else {
                divInfo.innerHTML = '주소를 찾을 수 없습니다.';
                console.log('주소 변환 실패: 결과가 없음');
            }
        } else {
            divInfo.innerHTML = '주소 변환에 실패했습니다.';
            console.error('Geocoder error:', status);
        }

        // 장소명 가져오기
        searchPlace(addressName, latlng, { radius: 20 })
            .then(data => {
                const closestPlace = data[0];
                const placeName = closestPlace.place_name;
                
                inpPlcName.value = placeName;
                divInfo.innerHTML = formatPlaceInfo(closestPlace);

                console.log('장소명 변환 성공:', placeName);
                console.log('검색된 장소 상세 정보:', closestPlace);
                console.log('검색된 장소들:', data.map(place => ({
                    name: place.place_name,
                    distance: place.distance,
                    phone: place.phone,
                    category: place.category_name
                })));
            })
            .catch(error => {
                divInfo.innerHTML = '장소명을 찾을 수 없습니다.';
                console.log('장소명 변환 실패:', error.message);
            });
    })

    // 화면 입력부에 위도 경도 설정
    // 소숫점 7자리까지 표현
    inpLat.value = Number(getLat.toFixed(7));
    inpLng.value = Number(getLng.toFixed(7));
})

// 마커에 클릭 이벤트 등록
kakao.maps.event.addListener(tempMarker, 'click', (mouseEvent)=>{
    if(tempMarker.getMap()){
        tempMarker.setMap(null);

        // 입력부 클리어
        inpClear();

    }else{
        tempMarker.setMap(map);
    }
})


// DB 받아와서 마커 찍기
// 전체 마커 조회
async function getMarkers(){
    try { 
        // 이미 보이는 상태면 -> 지도에서 제거하고 끝냄
        if(markersVisible){
            savedMarkers.forEach(m=>m.setMap(null));
            markersVisible = false;
            // 입력부 클리어
            inpClear();

            infowindow.close();
            return;
        }

        // 서버에서 데이터 가져오기
        const res = await fetch('/markers');       // 요청 대기
        if (!res.ok) { // fetch가 성공했는지 (HTTP 상태 코드가 200-299인지) 확인합니다.
            console.error('서버에서 마커 데이터를 가져오는데 실패했습니다. 상태:', res.status);
            return;
        }

        const markers = await res.json()           // JSON 변환 대기

        // 기존 마커 초기화
        savedMarkers.forEach(m=>m.setMap(null));
        savedMarkers = [];

        markers.forEach((marker) =>{

            const savedMarker = new kakao.maps.Marker({
                map: map,       // 마커를 표시할 지도
                position: new kakao.maps.LatLng(marker.lat, marker.lng),    // 마커를 표시할 위치
                title: marker.name,    // 마커의 타이틀, 마커에 마우스를 올리면 타이틀이 표시됩니다
                image : markerImage
            });

            // savedMarker에 id, name 셋팅
            savedMarker.id = marker.id;
            savedMarker.name = marker.name;

            // 마커에 클릭 이벤트 등록
            kakao.maps.event.addListener(savedMarker, 'click', ()=>{

                // 현재 선택된 저장마커 데이터 셋팅
                curSavedMarker = savedMarker;

                // markerId 가져오기
                const markerId = savedMarker.id;

                // 클릭한 위도, 경도 정보 가져오기
                let latlng = savedMarker.getPosition();
                let getLat = latlng.getLat()
                let getLng = latlng.getLng()

                // 화면 입력부에 이름 위도 경도 설정
                const markerTitle = savedMarker.getTitle() || savedMarker.name || '알 수 없는 장소';
                inpPlcName.value = markerTitle;
                // 소숫점 7자리까지 표현
                inpLat.value = Number(getLat.toFixed(7));
                inpLng.value = Number(getLng.toFixed(7));

                // 저장된 마커 클릭 시에도 해당 위치의 상세 정보 가져오기
                // 좌표 => 주소 변환
                geocoder.coord2Address(getLng, getLat, (result, status) => {
                    let addressName = "";
                    if(status === kakao.maps.services.Status.OK){
                        // 주소 정보가 있는 경우
                        if(result && result.length > 0){
                            const address = result[0].address;
                            const roadAddress = result[0].road_address;
                            
                            // 도로명주소가 있으면 도로명주소를, 없으면 지번주소를 사용
                            addressName = roadAddress ? roadAddress.address_name : address.address_name;
                        }
                    }

                    // 마커 타이틀이 유효한 경우에만 장소 검색 시도
                    if(markerTitle && markerTitle !== '알 수 없는 장소') {
                        // 장소 검색으로 상세 정보 가져오기
                        searchPlace(markerTitle, latlng, { radius: 100 })
                            .then(data => {
                                const place = data[0];
                                divInfo.innerHTML = formatPlaceInfo(place);
                                console.log('저장된 마커 상세 정보:', place);
                            })
                            .catch(error => {
                                // Places API로 정보를 찾을 수 없는 경우 기본 정보만 표시
                                divInfo.innerHTML = `<strong>장소명:</strong> ${markerTitle}<br>`;
                                divInfo.innerHTML += `<strong>주소:</strong> ${addressName}<br>`;
                                divInfo.innerHTML += `<em>상세 정보를 찾을 수 없습니다.</em>`;
                            });
                    } else {
                        // 마커 타이틀이 없는 경우 주변 장소 검색으로 대체
                        searchPlace(addressName, latlng, { radius: 50 })
                            .then(data => {
                                const closestPlace = data[0];
                                divInfo.innerHTML = formatPlaceInfo(closestPlace);
                                console.log('주변 장소 검색 결과:', closestPlace);
                            })
                            .catch(error => {
                                // 기본 정보만 표시
                                divInfo.innerHTML = `<strong>장소명:</strong> ${markerTitle}<br>`;
                                divInfo.innerHTML += `<strong>주소:</strong> ${addressName}<br>`;
                                divInfo.innerHTML += `<em>상세 정보를 찾을 수 없습니다.</em>`;
                            });
                    }
                });
            })

            // 전역 배열에 저장
            savedMarkers.push(savedMarker);
        })
        // 보이는 상태로 업데이트
        markersVisible = true;

    } catch (error) {
        console.error(error); // 에러 처리
    }
}

// 개별 마커 저장
function setMarker(){
    if(!inpPlcName.value){
        alert("장소명을 입력해주세요")
        return
    }

    let obj = {
        name : inpPlcName.value,
        lat : inpLat.value,
        lng : inpLng.value
    }

    if(curSavedMarker?.id){
        let curMarkerId = curSavedMarker.id;

        // 수정한 내용 있는지 확인
        if(inpPlcName.value === curSavedMarker.name){
            alert("수정할 내용이 없습니다.");
            return;
        }

        // 수정
        fetch(`/markers/${curMarkerId}`,{
            method : 'PUT',
            headers : {
                'Content-Type' : 'application/json'
            },
            body : JSON.stringify(obj)
        })
        .then(res => {
            if(!res.ok){
                throw new Error('서버 응답 에러 : ' + res.status)
            }
            return res.json()
        })
        .then(data => {
            if(data.success){
                if(!confirm("수정하시겠습니까?")) return;
                alert("마커를 수정했습니다.");
            }else{
                alert("마커 수정을 실패했습니다.")
            }
        })
        .catch(err=>{
            console.error('요청실패:', err);
        })
    }else{
        // 생성
        fetch('/markers',{
            method : 'POST',
            headers : {
                'Content-Type' : 'application/json'
            },
            body : JSON.stringify(obj)
        })
        .then(res => {
            if(!res.ok){
                throw new Error('서버 응답 에러 : ' + res.status)
            }
            return res.json()
        })
        .then(data => {
            if(data.success){
                alert("마커를 등록했습니다.");

                // 카카오맵에 마커 찍기
                const marker = tempMarker;
                marker.setImage(markerImage);   // 마커이미지
                marker.setTitle(obj.name);      // 마커타이틀
            }else{
                alert("마커 등록을 실패했습니다.")
            }
        })
        .catch(err=>{
            console.error('요청실패:', err);
        })
    }
}

// 개별 마커 삭제
function deleteMarker(){
    if(curSavedMarker?.id){
        let curMarkerId = curSavedMarker.id;    // 현재 선택된 마커의 id

        if(!confirm("정말 삭제하겠습니까?")) return;
        fetch(`/markers/${curMarkerId}`,{
            method : "DELETE"
        }).then(res => {
            if(!res.ok){
                // 서버에서 에러 응답 반환 시
                return res.text().then(msg => {
                    throw new Error(msg || `삭제 실패 (status : ${res.status})`)
                })
            }
            return res.json().catch(()=>({}));
        }).then(()=>{
            alert("삭제되었습니다.");
            window.location.reload();
        }).catch((err)=>{
            console.error(err);
            alert(`삭제 중 오류가 발생했습니다 : ${err.message}`);
        })
    }    
}

//====================헬퍼 함수 =============================//
// 입력부 클리어
function inpClear(){
    inpPlcName.value = "";
    inpLat.value = "";
    inpLng.value = "";
    divInfo.innerHTML = '';
}

// 공통 장소 검색 함수
function searchPlace(keyword, location, options = {}) {
    const defaultOptions = {
        location: location,
        radius: options.radius || 100,
        sort: 'distance'
    };
    
    return new Promise((resolve, reject) => {
        ps.keywordSearch(keyword, (data, status) => {
            if (status === kakao.maps.services.Status.OK && data && data.length > 0) {
                resolve(data);
            } else {
                reject(new Error('장소 검색 실패'));
            }
        }, defaultOptions);
    });
}

// 장소 정보를 HTML로 포맷팅하는 함수
function formatPlaceInfo(place) {
    let html = `<strong>장소명:</strong> ${place.place_name}<br>`;

    if (place.address_name) {
        html += `<strong>지번주소:</strong> ${place.address_name}<br>`;
    }

    if (place.road_address_name) {
        html += `<strong>도로명주소:</strong> ${place.road_address_name}<br>`;
    }
    
    if (place.distance) {
        html += `<strong>거리:</strong> ${Math.round(place.distance)}m<br>`;
    }
    
    if (place.phone) {
        html += `<strong>전화번호:</strong> ${place.phone}<br>`;
    }
    
    if (place.category_name) {
        html += `<strong>카테고리:</strong> ${place.category_name}<br>`;
    }
    
    return html;
}

</script>
</body>
</html>