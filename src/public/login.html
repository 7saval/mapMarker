<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>로그인</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="./css/style.css">
</head>
<body class="d-flex flex-column vh-100">
    <!-- 내비게이션 바 위치 -->
    <div id="navbar-container"></div>

    <main class="form-signin w-100 m-auto text-center border">
        <div class="container">
            <form id="form">
                <h1 class="h3 mb-3 fw-normal">로그인</h1>
                <div class="form-floating mb-3">
                    <input type="email" class="form-control" id="email" name="email" placeholder="name@example.com">
                    <label for="floatingInput">Email address</label>
                </div>
                <div class="form-floating">
                    <input type="password" class="form-control" id="password" name="password" placeholder="Password">
                    <label for="floatingPassword">Password</label>
                </div>
                <button class="mt-3 w-100 btn btn-lg btn-primary" type="submit" onclick="fn_login(event)">Sign in</button>
            </form>
            <div id="msg" role="status"></div>
        </div>
    </main>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // 변수 선언
        const form = document.getElementById("form");   // 폼
        const inpEmail = document.getElementById("email");   // 이메일
        const inpPassword = document.getElementById("password");   // 비밀번호
        const msg = document.getElementById("msg");   // 메세지

        // 로그인
        function fn_login(event){
            event.preventDefault();     // 기본 submit 방지 (페이지 새로고침 방지)
            msg.textContent = '';       // 초기화
            const data = {
                email : inpEmail.value,
                password : inpPassword.value
            }

            // 로그인 api 호출
            fetch('/users/login',{
                method : 'POST',
                headers : {
                    'Content-Type' : 'application/json'
                },
                credentials: 'include',
                body : JSON.stringify(data)
            })
            .then(res => {
                // 200~299 성공 
                if(res.ok){
                    return res.json();
                } else if (res.status === 400){     // 잘못된 값 입력력 시
                    return res.json().then(errors => {
                        if(Array.isArray(errors) && errors.length > 0){
                            alert(errors[0].msg || '입력 정보를 확인해주세요.');
                        } else{
                            alert('입력 정보를 확인해주세요.');
                        }
                        throw new Error('Validation Error');
                    });
                } else if (res.status === 401){     // 비인증 시
                    return res.json();
                } else{                             // 500 서버 에러
                    throw new Error('서버 응답 에러 : ' + res.status);
                }
            })
            .then(data => {
                if(data.success){
                    alert(data.message);
                    location.href = './';
                }
                else{
                    // 인증 실패(잘못된 비밀번호 등)
                    msg.style.color = 'red';
                    msg.textContent = data.message || '아이디 또는 비밀번호가 일치하지 않습니다.';
                }
                
            })
            .catch(err => {
                // Validation Error는 이미 알림창으로 표시했으므로 콘솔만 출력
                if(err.message !== 'Validation Error') {
                    console.error('요청 실패 : ' + err);
                    alert(err);
                }
            })

        }
    </script>
    <script src="/js/nav.js"></script>
    <script>
        // nav 로더 사용: nav.js의 Nav.load를 호출하면 navBar를 삽입하고 auth 초기화를 수행합니다.
        if(window.Nav && typeof window.Nav.load === 'function'){
            window.Nav.load();
        }
    </script>
</body>
</html>
