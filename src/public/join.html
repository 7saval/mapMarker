<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>회원가입</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="./css/style.css">
</head>
<body class="d-flex flex-column vh-100">
    <!-- 내비게이션 바 위치 -->
    <div id="navbar-container"></div>

    <main class="form-signin w-100 m-auto text-center border">
        <div class="container">
            <form id="form">
                <h1 class="h3 mb-3 fw-normal">회원가입</h1>
                <div class="form-floating mb-3">
                    <input type="email" class="form-control" id="email" name="email" placeholder="name@example.com">
                    <label for="floatingInput">Email address</label>
                </div>
                <div class="form-floating mb-3">
                    <input type="password" class="form-control" id="password" name="password" placeholder="Password">
                    <label for="floatingPassword">Password</label>
                </div>
                <div class="form-floating">
                    <input type="text" class="form-control" id="UserName" name="UserName" placeholder="User Name">
                    <label for="floatingPassword">User Name</label>
                </div>
                <button class="mt-3 w-100 btn btn-lg btn-primary" type="submit" onclick="fn_join(event)">Join</button>
            </form>
        </div>
    </main>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // 변수 선언
        const form = document.getElementById("form");   // 폼
        const inpEmail = document.getElementById("email");   // 이메일
        const inpPassword = document.getElementById("password");   // 비밀번호
        const inpUserName = document.getElementById("UserName");   // 이름

        // 회원가입 
        function fn_join(event){
            event.preventDefault(); // 기본 submit 방지 (페이지 새로고침 방지)
            const data = {
                email : inpEmail.value,
                password : inpPassword.value,
                userName : inpUserName.value,
            }
            
            // 회원가입 api 호출
            fetch('/users/join',{
                method : 'POST',
                headers : {
                    'Content-Type' : 'application/json'
                },
                body : JSON.stringify(data)
            })
            .then(res => {
                // 유효성 검사 실패 시 (400 Bad Request)
                if(res.status === 400) {
                    return res.json().then(errors => {
                        // express-validator는 배열 형태로 에러를 반환
                        if(Array.isArray(errors) && errors.length > 0) {
                            // 첫 번째 에러 메시지를 알림창으로 표시
                            alert(errors[0].msg || '입력 정보를 확인해주세요.');
                        } else {
                            alert('입력 정보를 확인해주세요.');
                        }
                        throw new Error('Validation Error');
                    });
                }
                if(!res.ok) throw new Error('서버 응답 에러 : ' + res.status);
                return res.json()
            })
            .then(data => {
                if(data.success) {
                    alert(data.message);
                    location.href = './login';
                }else{
                    alert('회원가입 실패');
                }
            })
            .catch(err => {
                // Validation Error는 이미 알림창으로 표시했으므로 콘솔만 출력
                if(err.message !== 'Validation Error') {
                    console.error('요청 실패 : ', err);
                }
            })
        }
        
    </script>
    <script src="/js/nav.js"></script>
    <script>
        if(window.Nav && typeof window.Nav.load === 'function'){
            window.Nav.load();
        }
    </script>
</body>
</html>
